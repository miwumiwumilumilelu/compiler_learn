# 第十章 寄存器分配

不同存储介质成本和访问速度不同，采用**层次化存储结构**来让计算机既能高速访问存储又能保持高性价比

程序中定义的访存变量个数远大于寄存器的个数，大多数硬件体系结构在程序执行时总是需要将变量放入寄存器。**将程序执行过程中的访存变量都映射到寄存器中**，这个过程称为**寄存器分配**



LLVM中寄存器分配阶段目的：将MIR中使用的虚拟寄存器映射到目标机器的物理寄存器上

1. 当存在可用的物理寄存器时，将变量映射到物理寄存器中
2. 当没有可用的物理寄存器时，进行**溢出**，即将已经分配寄存器的变量重新放入内存中，得到一个空闲的寄存器，并为当前变量分配寄存器

LLVM中，寄存器分配共**4种分配算法**：

1. **Fast：**默认在O0优化级编译下使用，以**函数为粒度**进行寄存器分配，每个基本块都可以使用全部的物理寄存器。并不考虑变量的活跃区间，遇到变量无法分配的情况则溢出

2. **Basic：**以**函数为粒度**进行寄存器分配，**基于变量活跃区间**进行寄存器分配

   首先对活跃区间按照权重排序

   按照权重**从高到低**逐一分配：

   ​	如果可以为虚拟寄存器分配物理寄存器，则直接分配；

   ​	如果不可以，则选择虚拟寄存器暂存在栈中，并将使用虚拟寄存器的地方重新插入加载指令（从栈中加载数据）

   实验性质的寄存器分配算法，并不用于生产环境中，而是**用于性能基准测试和比较新型寄存器分配算法**

3. **Greedy：**LLVM默认的分配器，以**函数为粒度**进行寄存器分配。和Basic相比，其在寄存器溢出实现上更为复杂，其**目标是生成最小溢出成本的代码**

4. **PBQP：**以**函数为粒度**进行寄存器分配，通过构造一个PBQP来表示寄存器分配问题（**将活跃变量区间等约束转换为方程组**）

   然后通过对PBQP求解来获得结果，再将求解结果映射回寄存器分配



## 10.1 寄存器分配流程解析